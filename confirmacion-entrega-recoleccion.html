<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direcciones - GreenHaul</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/pages.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="container navbar-content">
                <a href="index.html" class="logo">
                    <img src="assets/img/Greenhaul-fl.svg" alt="Logo de GreenHaul">
                </a>
                <button class="navbar-toggler" id="navbarToggler" aria-label="Toggle navigation">
                    <span class="toggler-icon"></span>
                    <span class="toggler-icon"></span>
                    <span class="toggler-icon"></span>
                </button>
                <div class="navbar-collapse" id="navbarCollapse">
                    <ul class="nav-links-list">
                        <li><a href="index.html" class="nav-link active">Inicio</a></li>
                        <li><a href="productos.html" class="nav-link">Productos</a></li>
                        <li><a href="servicios.html" class="nav-link">Servicios</a></li>
                        <li><a href="nosotros.html" class="nav-link">Nosotros</a></li>
                        <li><a href="contacto.html" class="nav-link">Contacto</a></li>
                        <li><a href="faq.html" class="nav-link">Preguntas</a></li>
                    </ul>
                    <div class="navbar-right-items">
                        <div class="navbar-user-actions" id="navbarUserActions">
                            <a href="login.html" class="btn btn-outline" id="loginBtn">Iniciar Sesi√≥n</a>
                            <a href="cuenta.html" class="nav-link" id="accountLink" style="display: none;">Hola, <span id="userName"></span></a>
                            <button class="btn-tertiary" id="logoutBtn" style="display: none;" title="Cerrar Sesi√≥n"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                        <div class="nav-icons">
                            <a href="#" class="nav-icon cart-icon" id="cartIcon">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="cart-count" id="cartCount">0</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="page-content">
        <section class="section">
            <div class="container">
                <div class="section-title">
                    <h2>Direcciones de tu Mudanza üó∫Ô∏è</h2>
                    <p>Confirma tus direcciones antes de proceder al pago.</p>
                </div>
                <div class="contact-grid">
                    <div class="contact-form-container">
                        <h3>Direcci√≥n de Entrega <span class="emoji">üè°</span></h3>
                        
                        <div class="form-group" id="saved-delivery-addresses-container" style="display: none;">
                            <label for="savedDeliveryAddress">Elige una de tus direcciones</label>
                            <select id="savedDeliveryAddress" class="form-control">
                                <option value="">-- Elige una direcci√≥n --</option>
                            </select>
                        </div>
                        <p class="map-instruction">O arrastra el pin para ajustar la ubicaci√≥n.</p>
                        <form id="deliveryAddressForm">
                            <div class="form-group">
                                <label for="deliveryAddress">Direcci√≥n Completa</label>
                                <input type="text" id="deliveryAddress" class="form-control" placeholder="La direcci√≥n aparecer√° aqu√≠..." required>
                            </div>
                            <div class="map-container" id="deliveryMap"></div>
                            <button type="submit" class="btn btn-primary" style="width:100%;">Confirmar Direcci√≥n</button>
                        </form>
                    </div>
                    <div class="contact-form-container">
                        <h3>Direcci√≥n de Recolecci√≥n <span class="emoji">üöö</span></h3>
                        
                        <div class="form-group" id="saved-pickup-addresses-container" style="display: none;">
                            <label for="savedPickupAddress">Elige una de tus direcciones</label>
                            <select id="savedPickupAddress" class="form-control">
                                <option value="">-- Elige una direcci√≥n --</option>
                            </select>
                        </div>
                        <p class="map-instruction">O arrastra el pin para ajustar la ubicaci√≥n.</p>
                        <form id="pickupAddressForm">
                            <div class="form-group">
                                <label for="pickupAddress">Direcci√≥n Completa</label>
                                <input type="text" id="pickupAddress" class="form-control" placeholder="La direcci√≥n aparecer√° aqu√≠..." required>
                            </div>
                            <div class="map-container" id="pickupMap"></div>
                            <button type="submit" class="btn btn-primary" style="width:100%;">Confirmar Direcci√≥n</button>
                        </form>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-primary btn-big-cta" id="finalizeOrderBtn">Continuar al Pago</button>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="footer">
       </footer>
    
    <div class="cart-notification" id="cartNotification"><div class="notification-content"><div class="notification-icon-wrapper"><span class="notification-icon"></span></div><p id="notificationText"></p></div></div>

    <script src="assets/js/main.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let isDeliveryAddressConfirmed = false;
        let isPickupAddressConfirmed = false;
        const initialCoords = [19.4326, -99.1332]; // CDMX por defecto
        const backendUrl = 'https://greenhaul-backend-production.up.railway.app';
        
        let deliveryMap, deliveryMarker;
        let pickupMap, pickupMarker;

        // --- Funci√≥n para inicializar los mapas ---
        function setupMap(mapId, inputId, onDragEndCallback) {
            const map = L.map(mapId).setView(initialCoords, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const marker = L.marker(initialCoords, { draggable: true }).addTo(map);
            marker.on('dragend', onDragEndCallback);
            setTimeout(() => map.invalidateSize(), 400);
            return { map, marker };
        }

        // --- L√≥gica de geocodificaci√≥n (convertir coordenadas a texto y viceversa) ---
        async function updateAddressFromCoords(lat, lng, inputElement) {
            inputElement.value = "Buscando...";
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.display_name) {
                    inputElement.value = data.display_name;
                } else {
                    inputElement.value = "Direcci√≥n no encontrada.";
                }
            } catch (error) {
                inputElement.value = "Error al buscar direcci√≥n.";
            }
        }

        async function updateMapFromAddress(fullAddress, map, marker) {
            if (!fullAddress) return;
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullAddress)}&format=json&limit=1`;
            try {
                const response = await fetch(url);
                const results = await response.json();
                if (results && results.length > 0) {
                    const { lat, lon } = results[0];
                    const newPosition = L.latLng(lat, lon);
                    marker.setLatLng(newPosition);
                    map.setView(newPosition, 16);
                }
            } catch (error) {
                console.error("Error al geocodificar direcci√≥n:", error);
            }
        }
        
        // --- Inicializar mapa de Entrega ---
        const deliveryElements = setupMap('deliveryMap', 'deliveryAddress', (e) => {
            updateAddressFromCoords(e.target.getLatLng().lat, e.target.getLatLng().lng, document.getElementById('deliveryAddress'));
        });
        deliveryMap = deliveryElements.map;
        deliveryMarker = deliveryElements.marker;

        // --- Inicializar mapa de Recolecci√≥n ---
        const pickupElements = setupMap('pickupMap', 'pickupAddress', (e) => {
            updateAddressFromCoords(e.target.getLatLng().lat, e.target.getLatLng().lng, document.getElementById('pickupAddress'));
        });
        pickupMap = pickupElements.map;
        pickupMarker = pickupElements.marker;

        // --- L√ìGICA PARA CARGAR Y USAR DIRECCIONES GUARDADAS ---
        const loggedInUser = JSON.parse(localStorage.getItem('greenhaulUser'));
        if (loggedInUser && loggedInUser.id) {
            // Mostrar los contenedores de los men√∫s desplegables
            document.getElementById('saved-delivery-addresses-container').style.display = 'block';
            document.getElementById('saved-pickup-addresses-container').style.display = 'block';

            const deliverySelect = document.getElementById('savedDeliveryAddress');
            const pickupSelect = document.getElementById('savedPickupAddress');
            
            // Cargar las direcciones del usuario desde el backend
            fetch(`${backendUrl}/api/users/${loggedInUser.id}/addresses`)
                .then(response => response.json())
                .then(addresses => {
                    if (addresses && addresses.length > 0) {
                        addresses.forEach(addr => {
                            const option = document.createElement('option');
                            const fullAddress = `${addr.street}, ${addr.city}, ${addr.state || ''}, ${addr.postal_code || ''}`;
                            option.value = fullAddress; // Guardamos la direcci√≥n completa
                            option.textContent = addr.name; // Mostramos el nombre (ej. "Casa")
                            deliverySelect.appendChild(option.cloneNode(true));
                            pickupSelect.appendChild(option);
                        });
                    }
                });
            
            // Event listener para el men√∫ de Entrega
            deliverySelect.addEventListener('change', (e) => {
                const selectedAddress = e.target.value;
                if (selectedAddress) {
                    document.getElementById('deliveryAddress').value = selectedAddress;
                    updateMapFromAddress(selectedAddress, deliveryMap, deliveryMarker);
                }
            });

            // Event listener para el men√∫ de Recolecci√≥n
            pickupSelect.addEventListener('change', (e) => {
                const selectedAddress = e.target.value;
                if (selectedAddress) {
                    document.getElementById('pickupAddress').value = selectedAddress;
                    updateMapFromAddress(selectedAddress, pickupMap, pickupMarker);
                }
            });
        }
        
        // --- L√≥gica de confirmaci√≥n de formularios y pago ---
        document.getElementById('deliveryAddressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            isDeliveryAddressConfirmed = true;
            showNotification('Direcci√≥n de entrega confirmada.', 'success');
        });

        document.getElementById('pickupAddressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            isPickupAddressConfirmed = true;
            showNotification('Direcci√≥n de recolecci√≥n confirmada.', 'success');
        });

        document.getElementById('finalizeOrderBtn').addEventListener('click', () => {
            if (!isDeliveryAddressConfirmed || !isPickupAddressConfirmed) {
                showNotification('Por favor, confirma ambas direcciones.', 'error');
                return;
            }
            // Aqu√≠ guardar√≠as las direcciones seleccionadas antes de ir a pago
            // Ejemplo: sessionStorage.setItem('deliveryAddress', document.getElementById('deliveryAddress').value);
            window.location.href = 'pago.html';
        });
    });
    </script>
</body>
</html>
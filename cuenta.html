<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Cuenta - GreenHaul</title>
  
  <!-- Fuente de iconos FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
  />
  
  <!-- Estilos generales y variables CSS -->
  <style>
    /* ==========================================
       Variables de color y fuentes para toda la app
       ========================================== */
    :root {
      --primary-solid: #4a90e2;
      --accent-green: #00b386;
      --gradient-primary: linear-gradient(to right, #00b386, #4a90e2);
      --gradient-primary-hover: linear-gradient(to right, #008c6b, #3a7bcd);
      --color-dark: #2c3e50;
      --color-light: #f8f9fa;
      --color-text: #555;
      --color-white: #ffffff;
      --accent-orange: #ff9900;
      --accent-red: #e74c3c;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
      --border-color: #e0e0e0;
      --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
        Arial, sans-serif;
    }

    /* ==================================
       Reset básico y box sizing para todo
       ================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ==================================
       Estilos básicos para body y layout
       ================================== */
    body {
      font-family: var(--font-main);
      color: var(--color-text);
      background-color: var(--color-light);
      line-height: 1.7;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ==================================
       Contenedor principal centralizado
       ================================== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ==================================
       Sección general con padding vertical
       ================================== */
    .section {
      padding: 80px 0;
    }

    /* ============================
       Tipografías para títulos H2
       ============================ */
    h2 {
      font-size: 2.8rem;
      text-align: center;
      color: var(--color-dark);
      margin-bottom: 60px;
      font-weight: 700;
    }

    /* ============================
       Títulos H3 dentro de secciones
       ============================ */
    h3 {
      font-size: 1.8rem;
      color: var(--color-dark);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    /* ============================
       Estilos para botones principales
       ============================ */
    .btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 999px;
      font-weight: 600;
      text-align: center;
      border: none;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    /* Botones con gradiente primario */
    .btn-primary {
      background-image: var(--gradient-primary);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .btn-primary:hover {
      background-image: var(--gradient-primary-hover);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Botones con estilo outline */
    .btn-outline {
      background-color: var(--primary-solid);
      color: white !important;
      border-radius: 50px;
      text-decoration: none;
      padding: 8px 20px;
    }

    /* Botones terciarios para acciones pequeñas */
    .btn-tertiary {
      background: none;
      border: none;
      color: var(--accent-red);
      font-weight: 500;
      cursor: pointer;
      font-size: 1.2rem;
      transition: transform 0.2s ease;
    }
    .btn-tertiary:hover {
      transform: scale(1.15);
    }

    /* ============================
       Navbar estilos
       ============================ */
    .navbar {
      position: sticky;
      top: 0;
      padding: 15px 0;
      background-color: var(--color-white);
      border-bottom: 1px solid var(--border-color);
      z-index: 1000;
    }
    .navbar-content {
      display: flex;
      align-items: center;
      position: relative;
      justify-content: center;
      gap: 40px;
    }
    .logo {
      flex: 0 0 auto;
    }
    .nav-links-list {
      display: flex;
      gap: 30px;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .nav-link {
      font-weight: 500;
      color: var(--color-text);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .nav-link:hover {
      color: var(--primary-solid);
    }
    .nav-links-list .nav-link:focus,
    .nav-links-list .nav-link:active {
      outline: none;
      box-shadow: none;
    }
    .navbar-right-items {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 25px;
    }
    .navbar-user-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* ============================
       Footer estilos
       ============================ */
    .footer {
      background-color: var(--color-dark);
      color: #aaa;
      padding: 40px 20px;
      text-align: center;
      margin-top: auto;
    }

    /* ============================
       Layout principal y contenido
       ============================ */
    main {
      flex-grow: 1;
      padding-top: 80px;
    }
    .account-layout {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 40px;
      align-items: flex-start;
    }
    .account-sidebar {
      position: sticky;
      top: 120px;
    }
    .account-nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background-color: var(--color-white);
      border-radius: var(--border-radius);
      padding: 10px;
      box-shadow: var(--shadow);
    }
    .account-nav-link {
      padding: 12px 20px;
      border-radius: 8px;
      color: var(--color-text);
      font-weight: 500;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .account-nav-link i {
      width: 20px;
      text-align: center;
      color: var(--primary-solid);
    }
    .account-nav-link:hover {
      background-color: #f0f0f0;
      transform: translateX(5px);
    }
    .account-nav-link.active {
      background-image: var(--gradient-primary);
      color: var(--color-white);
      transform: translateX(0);
      box-shadow: 0 4px 10px rgba(0, 179, 134, 0.3);
    }
    .account-nav-link.active i {
      color: var(--color-white);
    }

    /* ============================
       Secciones y animación fade
       ============================ */
    .account-content {
      min-height: 500px;
    }
    .account-section {
      display: none;
      background-color: var(--color-white);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    .account-section.active {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    /* ============================
       Títulos dentro de secciones
       ============================ */
    .account-section > h3 {
      margin-top: 0;
    }
  </style>

  <!-- Estilos Leaflet para mapas -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+eC2Br4P1BksjyF38zYh0zQfDe0Dz7Vb7drP8uZ40="
    crossorigin=""
  />
  
  <!-- Estilos extra para mapa -->
  <style>
    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: var(--shadow);
    }
    /* Estilo para formulario de dirección */
    .address-form {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .address-form label {
      font-weight: 600;
    }
    .address-form input {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
    }
    .address-form button {
      width: 150px;
      align-self: flex-start;
    }
  </style>
</head>

<body>

  <!-- Navbar principal -->
  <header>
    <nav class="navbar">
      <div class="container navbar-content">
        <a href="index.html" class="logo">
          <img
            src="assets/img/Greenhaul-fl.svg"
            alt="Logo de GreenHaul"
            style="height: 55px;"
          />
        </a>

        <ul class="nav-links-list">
          <li><a href="index.html" class="nav-link">Inicio</a></li>
          <li><a href="productos.html" class="nav-link">Productos</a></li>
          <li><a href="servicios.html" class="nav-link">Servicios</a></li>
          <li><a href="nosotros.html" class="nav-link">Nosotros</a></li>
          <li><a href="contacto.html" class="nav-link">Contacto</a></li>
        </ul>

        <div class="navbar-right-items">
          <div class="navbar-user-actions">
            <a href="login.html" class="btn btn-outline" id="loginBtn" style="display: none;">Iniciar Sesión</a>
            <a href="cuenta.html" class="nav-link active" id="accountLink" style="display: flex;">
              Hola, <span id="userName"></span>
            </a>
            <button class="btn-tertiary" id="logoutBtn" title="Cerrar Sesión">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main class="page-content">
    <section class="section">
      <div class="container">
        <h2 id="account-title"></h2>
        <div class="account-layout">
          <!-- Sidebar navegación -->
          <aside class="account-sidebar">
            <nav class="account-nav">
              <a class="account-nav-link active" data-section="dashboard"
                ><i class="fas fa-th-large"></i> Resumen</a
              >
              <a class="account-nav-link" data-section="pedidos"
                ><i class="fas fa-box"></i> Mis Pedidos</a
              >
              <a class="account-nav-link" data-section="direcciones"
                ><i class="fas fa-map-marker-alt"></i> Mis Direcciones</a
              >
              <a class="account-nav-link" data-section="perfil"
                ><i class="fas fa-user-circle"></i> Mi Perfil</a
              >
            </nav>
          </aside>

          <!-- Contenido de secciones -->
          <div class="account-content">
            <!-- Sección Dashboard -->
            <div id="dashboard-section" class="account-section active">
              <h3>Resumen de Actividad</h3>
              <div class="dashboard-grid" id="dashboard-cards">
                <!-- Aquí van las tarjetas dinámicas -->
              </div>
            </div>

            <!-- Sección Pedidos -->
            <div id="pedidos-section" class="account-section">
              <h3>Historial de Pedidos</h3>
              <div class="order-list" id="order-history-container"></div>
            </div>

            <!-- Sección Direcciones -->
            <div id="direcciones-section" class="account-section">
              <h3>Mis Direcciones</h3>
              <div id="address-list"></div>
              <!-- Aquí se agregará formulario de direcciones -->
            </div>

            <!-- Sección Perfil -->
            <div id="perfil-section" class="account-section">
              <h3>Configuración de Perfil</h3>
              <form id="profileForm">
                <div class="form-grid">
                  <div class="form-group">
                    <label for="profile-name">Nombre(s)</label>
                    <input type="text" id="profile-name" disabled />
                  </div>
                  <div class="form-group">
                    <label for="profile-lastname">Apellidos</label>
                    <input type="text" id="profile-lastname" disabled />
                  </div>
                </div>
                <div class="form-group">
                  <label for="profile-email">Correo Electrónico</label>
                  <input type="email" id="profile-email" required />
                </div>
                <div class="form-group">
                  <label for="profile-whatsapp">Número de WhatsApp</label>
                  <input type="tel" id="profile-whatsapp" />
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0" />
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
              </form>
            </div>
        </div>
      </section>
    </main>
  
    <!-- Popup de notificaciones -->
    <div id="notificationPopup"></div>
  
    <!-- Modal para agregar o editar dirección -->
    <div id="addressModal" style="display:none; 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1100; justify-content: center; align-items: center;">
      <div style="background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); position: relative;" id="addressModalContent">
        <h3 id="addressModalTitle">Agregar Dirección</h3>
        
        <!-- Formulario de dirección -->
        <form id="addressForm" class="address-form">
          <label for="address-input">Dirección</label>
          <input type="text" id="address-input" placeholder="Escribe tu dirección aquí" autocomplete="off" />
  
          <label for="addressMap">Selecciona la ubicación en el mapa</label>
          <div id="addressMap" style="height: 300px; width: 100%; border-radius: 8px; margin: 10px 0;"></div>
  
          <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 15px;">
            <button type="button" id="cancelAddressBtn" class="btn btn-outline">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Dirección</button>
          </div>
        </form>
        
        <!-- Botón cerrar -->
        <button id="closeAddressModal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
    </div>
  
    <!-- Script principal -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let userData = {};
        const savedUser = JSON.parse(localStorage.getItem("greenhaulUser"));
  
        if (!savedUser) {
          window.location.href = "login.html";
          return;
        }
        userData = { ...savedUser };
  
        // Elementos UI
        const userNameSpan = document.getElementById("userName");
        const accountTitle = document.getElementById("account-title");
        const profileNameInput = document.getElementById("profile-name");
        const profileLastnameInput = document.getElementById("profile-lastname");
        const profileEmailInput = document.getElementById("profile-email");
        const profileWhatsappInput = document.getElementById("profile-whatsapp");
        const notificationPopup = document.getElementById("notificationPopup");
  
        // Dirección modal y mapa
        const addressModal = document.getElementById("addressModal");
        const addressForm = document.getElementById("addressForm");
        const addressInput = document.getElementById("address-input");
        const cancelAddressBtn = document.getElementById("cancelAddressBtn");
        const closeAddressModalBtn = document.getElementById("closeAddressModal");
        const addressListContainer = document.getElementById("address-list");
  
        let addressMap, addressMarker;
        let isMapInitialized = false;
  
        // Mostrar notificaciones
        function showNotification(message, isError = false) {
          notificationPopup.textContent = message;
          notificationPopup.classList.add("show");
          if (isError) {
            notificationPopup.classList.add("notification-error");
          } else {
            notificationPopup.classList.remove("notification-error");
          }
          setTimeout(() => {
            notificationPopup.classList.remove("show");
            notificationPopup.classList.remove("notification-error");
          }, 3000);
        }
  
        // Renderizar tarjetas resumen (dashboard)
        function renderDashboard(data) {
          const dashboard = document.getElementById("dashboard-cards");
          dashboard.innerHTML = `
                  <div class="dashboard-card">
                      <div class="card-header"><h4>Monto Total</h4><div class="icon"><i class="fas fa-dollar-sign"></i></div></div>
                      <div class="card-body"><span>$${data.totalAmount.toFixed(2)}</span></div>
                  </div>
                  <div class="dashboard-card">
                      <div class="card-header"><h4>Total de Cajas</h4><div class="icon"><i class="fas fa-box-open"></i></div></div>
                      <div class="card-body"><span>${data.totalBoxes}</span></div>
                  </div>
                  <div class="dashboard-card">
                      <div class="card-header"><h4>Próxima Recolección</h4><div class="icon"><i class="fas fa-calendar-check"></i></div></div>
                      <div class="card-body"><span>${data.nextPickup || "Sin fecha"}</span></div>
                  </div>
                  <div class="dashboard-card">
                      <div class="card-header"><h4>Último Pedido</h4><div class="icon"><i class="fas fa-history"></i></div></div>
                      <div class="card-body"><span>${data.lastOrderDate || "N/A"}</span></div>
                  </div>
              `;
        }
  
        // Renderizar lista de direcciones
        function renderAddresses(addresses = []) {
          addressListContainer.innerHTML = "";
  
          if (addresses.length === 0) {
            addressListContainer.innerHTML = "<p>No tienes direcciones guardadas.</p>";
          } else {
            addresses.forEach((addr, index) => {
              const div = document.createElement("div");
              div.className = "address-item";
              div.style = "margin-bottom: 12px; padding: 12px; background: #f7f7f7; border-radius: 8px;";
              div.innerHTML = `
                  <p style="margin-bottom: 6px;">${addr}</p>
                  <button class="btn btn-outline btn-edit" data-index="${index}">Editar</button>
                  <button class="btn btn-tertiary btn-delete" data-index="${index}">Eliminar</button>
              `;
              addressListContainer.appendChild(div);
            });
          }
  
          // Botón Añadir Dirección
          const addButton = document.createElement("button");
          addButton.textContent = "Añadir Dirección";
          addButton.className = "btn btn-primary";
          addButton.style.marginTop = "15px";
          addButton.addEventListener("click", () => openAddressModal());
          addressListContainer.appendChild(addButton);
  
          // Eventos para editar y eliminar
          document.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const idx = e.target.getAttribute("data-index");
              openAddressModal(idx);
            });
          });
          document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const idx = e.target.getAttribute("data-index");
              deleteAddress(idx);
            });
          });
        }
  
        // Abrir modal dirección, con index opcional para editar
        function openAddressModal(index = null) {
          addressModal.style.display = "flex";
          
          // Inicializar mapa después de que el modal sea visible
          setTimeout(() => {
            if (!isMapInitialized) {
              initAddressMap();
              isMapInitialized = true;
            } else {
              // Si ya está inicializado, solo redimensionar
              addressMap.invalidateSize();
            }
          }, 100);
          
          if (index !== null) {
            addressInput.value = userData.addresses[index];
            setTimeout(() => {
              locateAddressOnMap(userData.addresses[index]);
            }, 200);
            addressForm.dataset.editIndex = index;
            document.getElementById("addressModalTitle").textContent = "Editar Dirección";
          } else {
            addressInput.value = "";
            setTimeout(() => {
              if (addressMarker && addressMap) {
                addressMap.setView([19.4326, -99.1332], 13);
                addressMarker.setLatLng([19.4326, -99.1332]);
              }
            }, 200);
            addressForm.removeAttribute("data-editIndex");
            document.getElementById("addressModalTitle").textContent = "Agregar Dirección";
          }
        }
        
        // Inicializar mapa de direcciones
        function initAddressMap() {
          try {
            addressMap = L.map('addressMap').setView([19.4326, -99.1332], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '© OpenStreetMap contributors'
            }).addTo(addressMap);
            
            // Crear marcador draggable
            addressMarker = L.marker([19.4326, -99.1332], { 
              draggable: true 
            }).addTo(addressMap);
            
            // Evento cuando se mueve el marcador
            addressMarker.on('moveend', async function (e) {
              const latlng = e.target.getLatLng();
              const address = await reverseGeocode(latlng.lat, latlng.lng);
              if (address) {
                addressInput.value = address;
              }
            });
            
            // Evento para buscar dirección al escribir
            let typingTimer;
            addressInput.addEventListener('input', () => {
              clearTimeout(typingTimer);
              typingTimer = setTimeout(async () => {
                const addr = addressInput.value.trim();
                if (addr.length > 5) {
                  const coords = await geocode(addr);
                  if (coords && addressMap && addressMarker) {
                    addressMarker.setLatLng(coords);
                    addressMap.setView(coords, 15);
                  }
                }
              }, 1000);
            });
            
          } catch (error) {
            console.error('Error inicializando mapa:', error);
            showNotification('Error al cargar el mapa', true);
          }
        }
        
        // Geocodificar dirección a coordenadas
        async function geocode(address) {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', México')}&limit=1`
            );
            const data = await response.json();
            if (data && data.length > 0) {
              return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
            }
            return null;
          } catch (error) {
            console.error('Error en geocoding:', error);
            return null;
          }
        }
        
        // Geocodificación inversa: coordenadas a dirección
        async function reverseGeocode(lat, lng) {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
            );
            const data = await response.json();
            if (data && data.display_name) {
              return data.display_name;
            }
            return '';
          } catch (error) {
            console.error('Error en reverse geocoding:', error);
            return '';
          }
        }
        
        // Buscar dirección en mapa
        async function locateAddressOnMap(address) {
          if (!addressMap || !addressMarker) return;
          
          const coords = await geocode(address);
          if (coords) {
            addressMarker.setLatLng(coords);
            addressMap.setView(coords, 15);
          } else {
            // Si no encuentra la dirección, mantener ubicación por defecto
            addressMap.setView([19.4326, -99.1332], 13);
            addressMarker.setLatLng([19.4326, -99.1332]);
          }
        }
  
        // Cerrar modal dirección
        function closeAddressModal() {
          addressModal.style.display = "none";
          addressInput.value = "";
        }
  
        // Eliminar dirección
        function deleteAddress(index) {
          if (confirm("¿Estás seguro de eliminar esta dirección?")) {
            userData.addresses.splice(index, 1);
            saveUserData();
            renderAddresses(userData.addresses);
            showNotification("Dirección eliminada.");
          }
        }
  
        // Guardar datos en localStorage
        function saveUserData() {
          localStorage.setItem("greenhaulUser", JSON.stringify(userData));
        }
  
        // Guardar dirección desde formulario
        addressForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const addr = addressInput.value.trim();
          if (addr.length < 10) {
            alert("Por favor, escribe una dirección válida.");
            return;
          }
          const editIndex = addressForm.dataset.editIndex;
          if (editIndex !== undefined) {
            userData.addresses[editIndex] = addr;
            showNotification("Dirección actualizada correctamente.");
          } else {
            userData.addresses.push(addr);
            showNotification("Dirección agregada correctamente.");
          }
          saveUserData();
          renderAddresses(userData.addresses);
          closeAddressModal();
        });
  
        // Botones cerrar y cancelar modal
        cancelAddressBtn.addEventListener("click", closeAddressModal);
        closeAddressModalBtn.addEventListener("click", closeAddressModal);
  
        // Cerrar modal con click fuera del contenido
        addressModal.addEventListener("click", (e) => {
          if (e.target === addressModal) {
            closeAddressModal();
          }
        });
  
        // Inicialización general
        function init() {
          userNameSpan.textContent = userData.name || "Usuario";
          accountTitle.textContent = `Bienvenido/a, ${userData.name || "Usuario"}`;
  
          // Perfil
          profileNameInput.value = userData.name || "";
          profileLastnameInput.value = userData.lastname || "";
          profileEmailInput.value = userData.email || "";
          profileWhatsappInput.value = userData.whatsapp || "";
  
          // Dashboard
          renderDashboard({
            totalAmount: userData.totalAmount || 0,
            totalBoxes: userData.totalBoxes || 0,
            nextPickup: userData.nextPickup || null,
            lastOrderDate: userData.lastOrderDate || null,
          });
  
          // Direcciones
          if (!userData.addresses) {
            userData.addresses = [];
          }
          renderAddresses(userData.addresses);
        }
  
        // Guardar cambios perfil
        document.getElementById("profileForm").addEventListener("submit", (e) => {
          e.preventDefault();
          userData.email = profileEmailInput.value.trim();
          userData.whatsapp = profileWhatsappInput.value.trim();
          saveUserData();
          showNotification("Perfil actualizado correctamente.");
        });
  
        // Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("greenhaulUser");
          window.location.href = "login.html";
        });
  
        // Navegación entre secciones
        const navLinks = document.querySelectorAll(".account-nav-link");
        const sections = document.querySelectorAll(".account-section");
        navLinks.forEach((link) => {
          link.addEventListener("click", () => {
            navLinks.forEach((lnk) => lnk.classList.remove("active"));
            link.classList.add("active");
            const target = link.dataset.section;
            sections.forEach((sec) => {
              if (sec.id === target + "-section") {
                sec.classList.add("active");
              } else {
                sec.classList.remove("active");
              }
            });
          });
        });
  
        init();
      });
    </script>
    
    <!-- Scripts Leaflet al final -->
    <script
      src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
      integrity="sha256-k1uP05JwHvl3mOY3dCQc6v8FqU1HgMCNjfZg7yyx8+g="
      crossorigin=""
    ></script>
  
    <!-- Estilos adicionales para notificaciones y dashboard -->
    <style>
      #notificationPopup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--primary-solid);
        color: var(--color-white);
        padding: 12px 22px;
        border-radius: 50px;
        box-shadow: var(--shadow);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        font-weight: 600;
        z-index: 1200;
        font-size: 1rem;
      }
      #notificationPopup.show {
        opacity: 1;
        pointer-events: auto;
      }
      #notificationPopup.notification-error {
        background-color: var(--accent-red);
      }
  
      /* Dashboard cards */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
        gap: 25px;
      }
      .dashboard-card {
        background-color: var(--color-white);
        border-radius: var(--border-radius);
        padding: 20px 25px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: transform 0.3s ease;
      }
      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 179, 134, 0.3);
      }
      .dashboard-card .card-header {
        display: flex;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 15px;
        font-weight: 700;
        color: var(--primary-solid);
        font-size: 1.2rem;
      }
      .dashboard-card .card-header .icon {
        font-size: 1.5rem;
        color: var(--accent-green);
      }
      .dashboard-card .card-body span {
        font-size: 2.4rem;
        font-weight: 700;
        color: var(--color-dark);
      }
    </style>
  <!-- SECCIÓN MIS PEDIDOS -->
  <section id="orders-section" class="account-section" style="display:none;">
    <h2>Mis Pedidos</h2>

    <div id="orders-list" style="margin-top: 25px;">
      <!-- Aquí se cargan los pedidos del usuario dinámicamente -->
    </div>

    <div id="emptyOrdersMessage" style="display:none; text-align: center; margin-top: 40px; font-size: 1.25rem; color: var(--color-gray);">
      En espera de tu primer pedido.
    </div>
  </section>

  <script>
    // Función para renderizar lista de pedidos
    function renderOrders(orders = []) {
      const ordersList = document.getElementById("orders-list");
      const emptyMsg = document.getElementById("emptyOrdersMessage");
      ordersList.innerHTML = "";

      if (!orders.length) {
        emptyMsg.style.display = "block";
        return;
      }

      emptyMsg.style.display = "none";

      orders.forEach(order => {
        const orderDiv = document.createElement("div");
        orderDiv.className = "order-card";
        orderDiv.style = "background: var(--color-white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px;";

        orderDiv.innerHTML = `
          <h3>Pedido #${order.id}</h3>
          <p><strong>Fecha:</strong> ${new Date(order.date).toLocaleDateString()}</p>
          <p><strong>Monto Total:</strong> $${order.total.toFixed(2)}</p>
          <p><strong>Estado:</strong> ${order.status}</p>
          <p><strong>Cantidad de Cajas:</strong> ${order.boxCount}</p>
          <p><strong>Dirección de Entrega:</strong> ${order.deliveryAddress}</p>
        `;

        ordersList.appendChild(orderDiv);
      });
    }

    // Simular carga de pedidos desde almacenamiento local o API
    function loadOrders() {
      // Simulación: pedidos guardados en localStorage
      const ordersData = JSON.parse(localStorage.getItem("greenhaulOrders")) || [];

      // Renderizar pedidos
      renderOrders(ordersData);
    }

    // Inicializar sección de pedidos al cargar la página
    document.addEventListener("DOMContentLoaded", () => {
      loadOrders();

      // Selección de sección en menú: si orders-section activo, mostrar y ocultar otros
      const navLinks = document.querySelectorAll(".account-nav-link");
      navLinks.forEach(link => {
        if (link.dataset.section === "orders") {
          link.addEventListener("click", () => {
            // Mostrar solo sección pedidos
            document.querySelectorAll(".account-section").forEach(sec => {
              if (sec.id === "orders-section") {
                sec.style.display = "block";
              } else {
                sec.style.display = "none";
              }
            });
          });
        }
      });
    });
  </script>

  <style>
    /* Estilos para pedidos */
    .order-card {
      transition: box-shadow 0.3s ease;
      cursor: default;
    }
    .order-card:hover {
      box-shadow: 0 8px 20px rgba(0, 179, 134, 0.25);
    }
    .order-card h3 {
      margin-bottom: 8px;
      color: var(--primary-solid);
    }
    .order-card p {
      margin: 4px 0;
      font-size: 1rem;
      color: var(--color-dark);
    }
  </style>

    <!-- Parte 4 de 5 -->

    <style>
        /* Estilos para el popup del formulario de dirección */
        #addressPopupOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #addressPopup {
            background: var(--color-white);
            width: 450px;
            max-width: 90vw;
            padding: 20px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #addressPopup h4 {
            margin-bottom: 10px;
            color: var(--color-dark);
        }

        #addressPopup label {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 5px;
        }

        #addressPopup input[type="text"] {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        #addressPopup #map {
            height: 250px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
        }

        #addressPopupButtons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 15px;
        }

        #addressPopupButtons button {
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        #btnCancelAddress {
            background-color: #ccc;
            color: #333;
        }

        #btnCancelAddress:hover {
            background-color: #b3b3b3;
        }

        #btnSaveAddress {
            background-image: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 179, 134, 0.3);
        }

        #btnSaveAddress:hover {
            background-image: var(--gradient-primary-hover);
        }
    </style>

    <div id="addressPopupOverlay" aria-modal="true" role="dialog" aria-labelledby="addressPopupTitle">
        <div id="addressPopup">
            <h4 id="addressPopupTitle">Agregar / Editar Dirección</h4>
            <label for="addressInput">Dirección</label>
            <input type="text" id="addressInput" placeholder="Escribe una dirección..." autocomplete="off" />

            <div id="map"></div>

            <div id="addressPopupButtons">
                <button id="btnCancelAddress" type="button">Cancelar</button>
                <button id="btnSaveAddress" type="button">Guardar Dirección</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-o9N1jfz5FhPCt3TDtZ3E1e8CShpXnJf2b+7x3x0p6uI="
        crossorigin=""></script>

    <script>
        (() => {
            // Variables para el popup de dirección y mapa
            const addressPopupOverlay = document.getElementById('addressPopupOverlay');
            const addressInput = document.getElementById('addressInput');
            const btnCancelAddress = document.getElementById('btnCancelAddress');
            const btnSaveAddress = document.getElementById('btnSaveAddress');
            let map, marker;

            // Función para abrir el popup y inicializar el mapa
            function openAddressPopup(initialAddress = '', initialCoords = [20.6736, -103.344] /* Guadalajara centro */) {
                addressInput.value = initialAddress;
                addressPopupOverlay.style.display = 'flex';

                setTimeout(() => {
                    if (!map) {
                        // Inicializa el mapa solo una vez
                        map = L.map('map').setView(initialCoords, 15);

                        // Carga el tile layer OpenStreetMap
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '© OpenStreetMap'
                        }).addTo(map);

                        // Marker draggable inicial
                        marker = L.marker(initialCoords, { draggable: true }).addTo(map);

                        // Evento para actualizar la dirección cuando el marcador se mueve
                        marker.on('moveend', async (e) => {
                            const latlng = e.target.getLatLng();
                            const address = await reverseGeocode(latlng.lat, latlng.lng);
                            if (address) {
                                addressInput.value = address;
                            }
                        });
                    } else {
                        // Si el mapa ya existe, solo actualiza vista y marker
                        map.setView(initialCoords, 15);
                        marker.setLatLng(initialCoords);
                    }
                }, 200);
            }

            // Función para cerrar el popup
            function closeAddressPopup() {
                addressPopupOverlay.style.display = 'none';
            }

            // Evento cancelar
            btnCancelAddress.addEventListener('click', () => {
                closeAddressPopup();
            });

            // Evento guardar dirección (aquí debes agregar lógica para guardar en backend o local)
            btnSaveAddress.addEventListener('click', () => {
                const address = addressInput.value.trim();
                if (!address) {
                    alert('Por favor, escribe o selecciona una dirección válida.');
                    return;
                }
                // Aquí deberás implementar la lógica para guardar la dirección en la base de datos
                // o actualizar la UI y el localStorage en este ejemplo.

                // Por ahora, mostramos alerta y cerramos popup
                alert(`Dirección guardada:\n${address}`);

                closeAddressPopup();

                // TODO: refrescar lista de direcciones para mostrar la nueva dirección guardada
            });

            // Función para geocodificar dirección y obtener lat/lng
            async function geocode(address) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    }
                    return null;
                } catch (error) {
                    console.error('Error en geocoding:', error);
                    return null;
                }
            }

            // Función para geocodificación inversa: lat/lng a dirección
            async function reverseGeocode(lat, lng) {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data && data.display_name) {
                        return data.display_name;
                    }
                    return '';
                } catch (error) {
                    console.error('Error en reverse geocoding:', error);
                    return '';
                }
            }

            // Evento para actualizar el marcador al cambiar la dirección escrita
            addressInput.addEventListener('change', async () => {
                const addr = addressInput.value.trim();
                if (addr && map && marker) {
                    const coords = await geocode(addr);
                    if (coords) {
                        map.setView(coords, 15);
                        marker.setLatLng(coords);
                    }
                }
            });

            // Exponer función para abrir popup desde el exterior (para el botón Añadir Dirección)
            window.openAddressPopup = openAddressPopup;
        })();
    </script>
    <!-- Parte 5 de 5 -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias
            const addressList = document.getElementById('address-list');

            // Función para cargar direcciones guardadas (simulado con localStorage)
            function loadAddresses() {
                const saved = localStorage.getItem('greenhaulAddresses');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch {
                        return [];
                    }
                }
                return [];
            }

            // Función para guardar direcciones en localStorage
            function saveAddresses(addresses) {
                localStorage.setItem('greenhaulAddresses', JSON.stringify(addresses));
            }

            // Función para mostrar direcciones en la UI
            function renderAddressList() {
                const addresses = loadAddresses();
                addressList.innerHTML = '';

                if (addresses.length === 0) {
                    addressList.innerHTML = '<p>No tienes direcciones guardadas.</p>';
                } else {
                    addresses.forEach((addr, index) => {
                        const div = document.createElement('div');
                        div.className = 'address-item';
                        div.style.padding = '10px 15px';
                        div.style.marginBottom = '10px';
                        div.style.border = '1px solid var(--border-color)';
                        div.style.borderRadius = '8px';
                        div.style.backgroundColor = '#fff';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.alignItems = 'center';

                        const addrText = document.createElement('span');
                        addrText.textContent = addr;

                        // Botón para eliminar dirección
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Eliminar';
                        deleteBtn.className = 'btn btn-tertiary';
                        deleteBtn.style.fontSize = '0.9rem';
                        deleteBtn.addEventListener('click', () => {
                            if (confirm('¿Deseas eliminar esta dirección?')) {
                                const newAddresses = loadAddresses().filter((_, i) => i !== index);
                                saveAddresses(newAddresses);
                                renderAddressList();
                            }
                        });

                        div.appendChild(addrText);
                        div.appendChild(deleteBtn);
                        addressList.appendChild(div);
                    });
                }

                // Botón Añadir Dirección
                const addButton = document.createElement('button');
                addButton.textContent = 'Añadir Dirección';
                addButton.className = 'btn btn-primary';
                addButton.style.marginTop = '15px';
                addButton.addEventListener('click', () => {
                    // Abrir popup mapa para añadir dirección
                    window.openAddressPopup();
                });
                addressList.appendChild(addButton);
            }

            // Función para agregar dirección desde popup
            function addNewAddress(address) {
                const addresses = loadAddresses();
                addresses.push(address);
                saveAddresses(addresses);
                renderAddressList();
            }

            // Modificar la función btnSaveAddress del popup para guardar dirección aquí
            const btnSaveAddress = document.getElementById('btnSaveAddress');
            const addressInput = document.getElementById('addressInput');
            const addressPopupOverlay = document.getElementById('addressPopupOverlay');

            btnSaveAddress.addEventListener('click', () => {
                const newAddress = addressInput.value.trim();
                if (!newAddress) {
                    alert('Por favor, escribe o selecciona una dirección válida.');
                    return;
                }

                // Guardar en localStorage y actualizar UI
                addNewAddress(newAddress);

                // Cerrar popup
                addressPopupOverlay.style.display = 'none';
            });

            // Inicializa la lista de direcciones al cargar la página
            renderAddressList();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - GreenHaul</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css"> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        /*
         * --- Variables CSS Globales para el Dashboard y M√≥dulos de Cuenta ---
         * Estas variables son espec√≠ficas para la secci√≥n "Mi Cuenta" y sus componentes,
         * asegurando el degradado azul-verdoso que te gust√≥ y los colores de los elementos internos.
         */
        :root {
            /* Las variables de color primarias de styles.css ya est√°n cargadas.
             * Aqu√≠ definimos variables espec√≠ficas para el look del dashboard si difieren
             * o si necesitamos gradientes espec√≠ficos para el dashboard.
             */
            --account-primary-solid: #4AB3C1; /* El azul verdoso vibrante para el dashboard */
            --account-secondary-solid: #4a90e2; /* El azul para el dashboard */
            --gradient-account-primary: linear-gradient(120deg, var(--account-primary-solid) 0%, var(--account-secondary-solid) 100%);
            
            /* Reusamos las variables de styles.css para texto, bordes, sombras donde sea posible */
            --text-dark-account: #333; /* Ajustado por si el dark de styles.css es muy oscuro para aqu√≠ */
            --text-light-account: #666;
            --border-account: #e0e0e0;
            --shadow-account: 0 4px 15px rgba(0,0,0,0.08);
            --border-radius-account: 14px; /* Un poco m√°s grande para las tarjetas del dashboard */
            --widget-card-radius: 11px;
            --form-control-border-focus: rgba(74,144,226,0.2);
        }

        /* --- Estilos Generales de la P√°gina 'Mi Cuenta' --- */
        body { 
            background: #f1f5f9; /* Fondo gris claro espec√≠fico para esta p√°gina */
            /* font-family, line-height, color var(--text) ya vienen de styles.css */
        }

        /* Animaciones (si no est√°n ya en styles.css, de lo contrario, elim√≠nalas de aqu√≠) */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        .slide-up { animation: slideUp 0.7s cubic-bezier(.68,-0.55,.27,1.55); }
        @keyframes slideUp { 0% { transform: translateY(60px); opacity: 0; } 60% { transform: translateY(-8px); opacity: 1; } 100% { transform: translateY(0); } }

        /* --- Layout del Dashboard de la Cuenta --- */
        .account-dashboard-container { 
            max-width: 1280px; 
            margin: 0 auto; 
            padding: 0 15px; 
        }
        .account-dashboard-layout { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 38px; 
            align-items: flex-start; 
            margin: 0 auto; 
        }
        @media (max-width: 900px) { 
            .account-dashboard-layout { grid-template-columns: 1fr; gap: 18px; } 
            .account-sidebar { position: static; } 
        }

        /* --- Barra Lateral (Sidebar) de la Cuenta --- */
        .account-sidebar { 
            position: sticky; 
            top: 110px; 
            min-width: 220px; 
        }
        .user-card { 
            background: var(--gradient-account-primary); 
            color: #fff; 
            border-radius: var(--border-radius-account); 
            box-shadow: var(--shadow-account); 
            text-align: center; 
            padding: 36px 18px 24px 18px; 
            margin-bottom: 28px; 
        }
        .user-avatar { 
            background: #fff; 
            color: var(--account-secondary-solid); /* Azul para el √≠cono del avatar */
            border-radius: 50%; 
            width: 72px; height: 72px; 
            font-size: 2.8rem; 
            margin: 0 auto 18px auto; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 18px rgba(0,179,134,0.12); /* Sombra espec√≠fica */
        }
        .user-name { font-size: 1.3rem; font-weight: 700; letter-spacing: -1px; }
        .user-email { font-size: 1rem; opacity: 0.95; margin-bottom: 8px; }

        .account-nav { 
            background: #fff; 
            border-radius: var(--border-radius-account); 
            box-shadow: var(--shadow-account); 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            padding: 15px 0; 
        }
        .account-nav-link { 
            padding: 15px 28px; 
            border-radius: 10px; 
            color: var(--text-dark-account); 
            font-weight: 500; 
            text-decoration: none; 
            display: flex; align-items: center; gap: 18px; 
            transition: all 0.2s; 
            cursor: pointer; 
            font-size: 1.08rem;
        }
        .account-nav-link i { 
            width: 22px; 
            text-align: center; 
            font-size: 1.35rem; 
            color: var(--account-secondary-solid); /* Azul para los √≠conos de navegaci√≥n */
            opacity: 0.95;
        }
        .account-nav-link:hover { 
            background: #f3f8fe; /* Fondo azul claro al hover */
            color: var(--account-secondary-solid); /* Color azul al hover */
        }
        .account-nav-link.active { 
            background: var(--gradient-account-primary); 
            color: #fff; 
            font-weight: 700; 
            box-shadow: 0 6px 18px rgba(0,179,134,0.11); 
            transform: scale(1.04);
        }
        .account-nav-link.active i { color: #fff; }

        /* --- Contenido Principal de la Cuenta (secciones internas) --- */
        .account-content { min-height: 500px; }
        .account-section { 
            display: none; 
            background: #fff; 
            padding: 38px 35px 30px 35px; 
            border-radius: var(--border-radius-account); 
            box-shadow: var(--shadow-account);
        }
        .account-section.active { display: block; animation: fadeIn 0.45s; }

        /* --- Dashboard (Secci√≥n de Resumen) --- */
        .dashboard-widgets { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 30px; 
            margin-bottom: 36px; 
        }
        .widget-card { 
            background: #f8f9fa; 
            border-radius: var(--widget-card-radius); 
            box-shadow: 0 2px 10px rgba(0,179,134,0.09); /* Sombra espec√≠fica */
            text-align: center; 
            padding: 28px 12px 22px 12px; 
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .widget-card:hover { 
            box-shadow: 0 8px 24px rgba(0,179,134,0.19); 
            transform: translateY(-7px) scale(1.04);
        }
        .widget-card .widget-icon { 
            font-size: 2.6rem; 
            margin-bottom: 10px; 
            color: var(--account-secondary-solid); /* Azul para √≠conos de widgets */
        }
        .widget-card .widget-value { 
            font-size: 2rem; 
            font-weight: 700; 
            color: var(--account-secondary-solid); 
            margin-bottom: 4px;
        }
        .widget-card .widget-label { 
            font-size: 1.08rem; 
            color: var(--text-dark-account); 
            opacity: 0.7;
        }
        .widget-card.ahorro { 
            background: var(--gradient-account-primary);
            color:#fff; 
        }
        .widget-card.ahorro .widget-icon { color: #fff;}

        /* Tarjeta de Impacto Sostenible (reemplazo de gr√°fica) */
        .impact-card {
            background: var(--gradient-account-primary); 
            color: #fff;
            border-radius: var(--border-radius-account);
            box-shadow: 0 8px 28px rgba(74,144,226,0.09);
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            max-width: 660px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease-out;
        }
        .impact-card .icon-large { font-size: 4rem; margin-bottom: 15px; color: #fff; opacity: 0.9;}
        .impact-card h4 { font-size: 1.8rem; font-weight: 700; color: #fff; margin-bottom: 10px;}
        .impact-card p { font-size: 1.1rem; opacity: 0.9; margin-bottom: 0;}

        /* Acciones R√°pidas en el Dashboard */
        .quick-actions { margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;}
        .action-card { background: #f8f9fa; border-radius: var(--border-radius-account); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease;}
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1);}
        .action-card .action-icon { font-size: 3rem; color: var(--account-secondary-solid); margin-bottom: 15px;}
        .action-card h4 { font-size: 1.25rem; margin-bottom: 10px; color: var(--text-dark-account);}
        .action-card p { font-size: 0.95rem; color: var(--text-light-account); margin-bottom: 15px;}
        /* El btn dentro de action-card usa el estilo global de .btn */

        /* Resumen de Pedidos Recientes en el Dashboard */
        .recent-orders-summary { margin-top: 40px; }
        .recent-orders-summary .order-item {
            background: #fff;
            border-radius: 9px;
            margin-bottom: 12px;
            padding: 15px 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-account);
            box-shadow: 0 1px 5px rgba(74,144,226,0.05);
        }
        .recent-orders-summary .order-item strong { color: var(--account-secondary-solid); }

        /* --- Secci√≥n de Pedidos --- */
        .order-list { margin-top: 18px; }
        .order-list .order-item { 
            background: #f8f9fa; 
            border-radius: 9px; 
            margin-bottom: 16px; 
            padding: 20px 18px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            align-items: center; 
            gap: 12px; 
            border: 1px solid var(--border-account); 
            box-shadow: 0 2px 8px rgba(74,144,226,0.07); 
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .order-item:hover { 
            box-shadow: 0 8px 24px rgba(74,144,226,0.19); 
            transform: translateY(-4px) scale(1.02);
        }
        .order-item-status { 
            font-weight: bold; 
            padding: 5px 14px; 
            border-radius: 99px; 
            font-size: 0.97rem; 
            text-align: center;
        }
        .status-completado { color: var(--accent-green); background: rgba(0,179,134,0.11);}
        .status-activo { color: var(--primary-solid); background: rgba(74,144,226,0.11);}

        /* --- Estilos de Formularios (dentro de Perfil, Direcciones, Seguridad, Notificaciones) --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark-account);}
        .form-control[disabled] { background: #e9ecef; cursor: not-allowed; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-account); 
            border-radius: 8px; 
            font-size: 1rem; 
            font-family: inherit; 
            color: var(--text-dark-account);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; 
            border-color: var(--account-secondary-solid); 
            box-shadow: 0 0 0 3px var(--form-control-border-focus);
        }
        /* Ajustes para checkboxes */
        .account-section input[type="checkbox"] {
            width: auto !important; /* Anula el 100% de .form-control */
            margin-bottom: 0;
        }
        .account-section label[for$="-notifications"] { /* Labels de checkboxes */
            font-weight: normal;
            margin-bottom: 0;
        }
        .account-section .form-group.checkbox-group { /* Si usas un div para agrupar checkbox+label */
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* --- Secci√≥n de Direcciones --- */
        .address-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 15px; flex-wrap: wrap;}
        .address-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); gap: 22px; }
        .address-card { 
            background: #f8f9fa; 
            border-radius: var(--border-radius-account); 
            padding: 22px; 
            border: 1px solid var(--border-account); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 2px 9px rgba(0,179,134,0.07);
        }
        .address-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .address-card-header h4 { 
            color: var(--account-secondary-solid); 
            font-size: 1.2rem; 
            display: flex; align-items: center; gap: 10px; 
        }
        .address-card-body { flex-grow: 1; margin-bottom: 20px;}
        .address-card-actions { display: flex; align-items: center; gap: 15px; }
        .address-references-text { /* Estilo para las referencias en la tarjeta de direcci√≥n */
            font-size:0.9em; 
            color: var(--text-light-account); 
            margin-top: 5px; /* Peque√±o espacio para separarlo de otros detalles */
        }

        /* --- Modales de la Cuenta (Ej. Modal de A√±adir/Editar Direcci√≥n) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 10000; 
            opacity: 0; visibility: hidden; 
            transition: all 0.3s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible;}
        .modal-content { 
            background: #fff; 
            padding: 38px 28px; 
            border-radius: var(--border-radius-account); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.11); 
            width: 95%; max-width: 520px; 
            transform: scale(0.93); 
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content { transform: scale(1);}
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border-account); 
            padding-bottom: 15px; margin-bottom: 25px;
        }
        .modal-header h3 { margin: 0; font-weight: 700;}
        .modal-close { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-dark-account);}
        .modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 18px;}
        #address-map { 
            height: 220px; width: 100%; 
            border-radius: var(--border-radius-account); 
            margin-top: 18px; 
            border: 1px solid var(--border-account);
        }
        .modal-content p { /* P√°rrafo de instrucci√≥n del mapa en el modal */
            font-size:0.85rem; 
            color:var(--text-light-account); 
            margin-top:10px;
        }

        /* --- Responsive para secciones de cuenta y modales --- */
        @media (max-width: 600px) { 
            .account-section, .modal-content { padding: 25px 15px; } 
        }

        /* --- Estilos espec√≠ficos de texto en el Dashboard --- */
        #dashboard-section h3, #dashboard-section h4 { /* T√≠tulos del dashboard */
            color: var(--text); /* Mantener el color de texto general */
        }
        #dashboard-section h3 span { /* Nombre del usuario en el t√≠tulo */
            color: var(--primary-solid); /* Color primario de styles.css */
        }
        #dashboard-section p { /* P√°rrafos en el dashboard */
            color: var(--text-light); /* Color de texto ligero */
        }
        #dashboard-section h4 { /* Subt√≠tulos H4 */
            margin-top:50px;
        }
        #dashboard-section > p:last-of-type { /* Mensaje final de agradecimiento */
            text-align:center;
            color:var(--text-light);
            margin-top:22px;
        }

        /* Estilos para HRs */
        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 30px 0;
        }

        /* Estilos para textos de funcionalidad no implementada */
        #seguridad-section p:last-of-type, #notificaciones-section p:last-of-type {
            font-size:0.9rem;
            color:var(--text-light-account);
            margin-top:10px;
        }
        #notificaciones-section .form-group label {
            /* Asegura que los labels de los checkboxes no tengan el margen de un form-group normal si es necesario */
            margin-bottom: 0; 
        }

    </style>
</head>
<body>
<header>
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="logo"><img src="assets/img/Greenhaul-fl.svg" alt="Logo de GreenHaul"></a>
            <button class="navbar-toggler" id="navbarToggler" aria-label="Toggle navigation">
                <span class="toggler-icon"></span>
                <span class="toggler-icon"></span>
                <span class="toggler-icon"></span>
            </button>
            <div class="navbar-collapse" id="navbarCollapse">
                <ul class="nav-links-list">
                    <li><a href="index.html" class="nav-link">Inicio</a></li>
                    <li><a href="productos.html" class="nav-link">Productos</a></li>
                    <li><a href="servicios.html" class="nav-link">Servicios</a></li>
                    <li><a href="nosotros.html" class="nav-link">Nosotros</a></li>
                    <li><a href="contacto.html" class="nav-link">Contacto</a></li>
                    <li><a href="cuenta.html" class="nav-link active">Mi Cuenta</a></li>
                </ul>
                <div class="navbar-right-items">
                    <div class="navbar-user-actions" id="navbarUserActions">
                        <a href="login.html" class="btn btn-outline" id="loginBtn" style="display: none;">Iniciar Sesi√≥n</a>
                        <a href="cuenta.html" class="nav-link active" id="accountLink" style="display: flex;">Hola, <span id="userName"></span></a>
                        <button class="btn-tertiary" id="logoutBtn" title="Cerrar Sesi√≥n"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                    <div class="nav-icons">
                        <a href="#" class="nav-icon cart-icon" id="cartIcon">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count" id="cartCount">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<main class="page-content">
    <section class="section">
        <div class="account-dashboard-container">
            <h2 id="account-title"></h2>
            <div class="account-dashboard-layout">
                <aside class="account-sidebar">
                    <div class="user-card" id="userCard">
                        <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
                        <div class="user-name" id="userCardName">Usuario</div>
                        <div class="user-email" id="userCardEmail"></div>
                    </div>
                    <nav class="account-nav">
                        <a class="account-nav-link active" data-section="dashboard"><i class="fas fa-th-large"></i> Resumen</a>
                        <a class="account-nav-link" data-section="pedidos"><i class="fas fa-box"></i> Mis Pedidos</a>
                        <a class="account-nav-link" data-section="perfil"><i class="fas fa-user-circle"></i> Mi Perfil</a>
                        <a class="account-nav-link" data-section="direcciones"><i class="fas fa-map-marker-alt"></i> Mis Direcciones</a>
                        <a class="account-nav-link" data-section="seguridad"><i class="fas fa-shield-alt"></i> Seguridad</a>
                        <a class="account-nav-link" data-section="notificaciones"><i class="fas fa-bell"></i> Notificaciones</a>
                    </nav>
                </aside>
                <div class="account-content">
                    <div id="dashboard-section" class="account-section active fade-in">
                        <h3>Bienvenido de Nuevo a GreenHaul, <span id="dashboardUserName"></span>!</h3>
                        <p>Aqu√≠ tienes un resumen r√°pido de tu actividad y algunas acciones √∫tiles.</p>
                        
                        <h4>Tu Impacto y Actividad Reciente</h4>
                        <div class="dashboard-widgets">
                            <div class="widget-card slide-up">
                                <div class="widget-icon"><i class="fas fa-box"></i></div>
                                <div class="widget-value" id="widgetPedidos">0</div>
                                <div class="widget-label">Pedidos Activos</div>
                            </div>
                            <div class="widget-card slide-up">
                                <div class="widget-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="widget-value" id="widgetCompletados">0</div>
                                <div class="widget-label">Pedidos Completados</div>
                            </div>
                            <div class="widget-card slide-up">
                                <div class="widget-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <div class="widget-value" id="widgetDirecciones">0</div>
                                <div class="widget-label">Direcciones Guardadas</div>
                            </div>
                            <div class="widget-card slide-up ahorro">
                                <div class="widget-icon"><i class="fas fa-seedling"></i></div>
                                <div class="widget-value" id="widgetAhorro">0 kg</div>
                                <div class="widget-label">CO‚ÇÇ Ahorrado</div>
                                <div id="widgetAhorroEquivalente"></div>
                            </div>
                        </div>

                        <div class="impact-card">
                            <div class="icon-large"><i class="fas fa-leaf"></i></div>
                            <h4>¬°Tu Impacto Sostenible Crece!</h4>
                            <p>Cada mudanza y env√≠o con GreenHaul contribuye a un futuro m√°s verde.</p>
                            <p style="font-size:1.2rem; font-weight:bold; margin-top:10px;">¬°Gracias por tu compromiso con el planeta!</p>
                        </div>
                        <p>
                            Sigue contribuyendo a reducir la huella de carbono.
                        </p>

                        <h4>Acciones R√°pidas</h4>
                        <div class="quick-actions">
                            <div class="action-card slide-up">
                                <div class="action-icon"><i class="fas fa-box-open"></i></div>
                                <h4>Programar un Nuevo Servicio</h4>
                                <p>Inicia una nueva solicitud de mudanza o env√≠o.</p>
                                <a href="servicios.html" class="btn btn-primary">Agendar Ahora</a>
                            </div>
                            <div class="action-card slide-up">
                                <div class="action-icon"><i class="fas fa-user-edit"></i></div>
                                <h4>Actualizar Mi Perfil</h4>
                                <p>Modifica tu informaci√≥n personal o de contacto.</p>
                                <button class="btn btn-outline" data-target-section="perfil">Editar Perfil</button>
                            </div>
                            <div class="action-card slide-up">
                                <div class="action-icon"><i class="fas fa-map-marked-alt"></i></div>
                                <h4>Gestionar Direcciones</h4>
                                <p>A√±ade, edita o elimina tus direcciones guardadas.</p>
                                <button class="btn btn-outline" data-target-section="direcciones">Mis Direcciones</button>
                            </div>
                        </div>

                        <h4>Tus √öltimos Pedidos</h4>
                        <div class="recent-orders-summary" id="recent-orders-summary-container">
                            <p>Cargando tus pedidos m√°s recientes...</p>
                        </div>
                        <div style="text-align:center; margin-top:30px;">
                            <button class="btn btn-primary" data-target-section="pedidos">Ver Todos Mis Pedidos</button>
                        </div>
                    </div>

                    <div id="pedidos-section" class="account-section">
                        <h3>Historial de Pedidos</h3>
                        <div class="order-list" id="order-history-container"></div>
                    </div>

                    <div id="perfil-section" class="account-section">
                        <h3>Configuraci√≥n de Perfil</h3>
                        <form id="profileForm" autocomplete="off">
                            <div class="form-grid">
                                <div class="form-group"><label for="profile-name">Nombre(s)</label><input type="text" id="profile-name" class="form-control" disabled></div>
                                <div class="form-group"><label for="profile-lastname">Apellidos</label><input type="text" id="profile-lastname" class="form-control" disabled></div>
                            </div>
                            <div class="form-group"><label for="profile-email">Correo Electr√≥nico</label><input type="email" id="profile-email" class="form-control"></div>
                            <div class="form-group"><label for="profile-whatsapp">N√∫mero de WhatsApp</label><input type="tel" id="profile-whatsapp" class="form-control" placeholder="Ej. 5512345678"></div>
                            <hr>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </form>
                    </div>

                    <div id="direcciones-section" class="account-section">
                        <div class="address-header">
                            <h3>Mis Direcciones</h3>
                            <button class="btn btn-primary" id="addAddressBtn">Agregar Nueva Direcci√≥n</button>
                        </div>
                        <div class="address-list" id="address-list-container"></div>
                    </div>

                    <div id="seguridad-section" class="account-section">
                        <h3>Configuraci√≥n de Seguridad</h3>
                        <p>Administra tus credenciales y opciones de seguridad.</p>
                        <form id="securityForm">
                            <h4>Cambiar Contrase√±a</h4>
                            <div class="form-group">
                                <label for="current-password">Contrase√±a Actual</label>
                                <input type="password" id="current-password" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">Nueva Contrase√±a</label>
                                <input type="password" id="new-password" class="form-control" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-new-password">Confirmar Nueva Contrase√±a</label>
                                <input type="password" id="confirm-new-password" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Actualizar Contrase√±a</button>
                        </form>
                        <hr>
                        <h4>Autenticaci√≥n de Dos Factores (2FA)</h4>
                        <p>A√±ade una capa extra de seguridad a tu cuenta.</p>
                        <button id="toggle2FABtn" class="btn btn-outline">
                            <i class="fas fa-toggle-off"></i> Habilitar 2FA (No funcional)
                        </button>
                        <p>
                            *Esta funcionalidad a√∫n no est√° implementada en el backend.
                        </p>
                    </div>

                    <div id="notificaciones-section" class="account-section">
                        <h3>Preferencias de Notificaciones</h3>
                        <p>Controla c√≥mo y cu√°ndo recibes nuestras comunicaciones.</p>
                        <form id="notificationsForm">
                            <div class="form-group">
                                <input type="checkbox" id="email-notifications">
                                <label for="email-notifications">Recibir notificaciones por correo electr√≥nico</label>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="whatsapp-notifications">
                                <label for="whatsapp-notifications">Recibir notificaciones por WhatsApp</label>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="sms-notifications">
                                <label for="sms-notifications">Recibir notificaciones por SMS</label>
                            </div>
                            <p>
                                *La funcionalidad de guardar las preferencias de notificaci√≥n a√∫n no est√° implementada.
                            </p>
                            <button type="submit" class="btn btn-primary" disabled>Guardar Preferencias</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </section>
</main>
<div class="modal-overlay" id="addressModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Agregar Nueva Direcci√≥n</h3>
            <button class="modal-close" id="modalCloseBtn">&times;</button>
        </div>
        <form id="addressForm" autocomplete="off">
            <input type="hidden" id="addressId">
            <div class="form-group">
                <label for="address-name">Nombre de la Direcci√≥n (ej. Casa, Oficina)</label>
                <input type="text" id="address-name" class="form-control" placeholder="Ej. Mi Casa" required>
            </div>
            <div class="form-group">
                <label for="address-street">Calle y N√∫mero</label>
                <input type="text" id="address-street" class="form-control" placeholder="Ej. Av. Insurgentes Sur 123" required>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="address-neighborhood">Colonia</label>
                    <input type="text" id="address-neighborhood" class="form-control" placeholder="Ej. Roma Norte">
                </div>
                <div class="form-group">
                    <label for="address-city">Ciudad</label>
                    <input type="text" id="address-city" class="form-control" placeholder="Ej. Ciudad de M√©xico" required>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="address-state">Estado</label>
                    <input type="text" id="address-state" class="form-control" placeholder="Ej. CDMX">
                </div>
                <div class="form-group">
                    <label for="address-postal-code">C√≥digo Postal</label>
                    <input type="text" id="address-postal-code" class="form-control" placeholder="Ej. 03810">
                </div>
            </div>
            <div class="form-group">
                <label for="address-references">Referencias Adicionales</label>
                <textarea id="address-references" class="form-control" rows="3" placeholder="Ej. Edificio blanco con port√≥n verde, frente a un parque."></textarea>
            </div>
            <div id="address-map"></div>
            <p style="font-size:0.85rem; color:#888; margin-top:10px;">Arrastra el marcador para ajustar la ubicaci√≥n exacta.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" id="modalCancelBtn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Direcci√≥n</button>
            </div>
        </form>
    </div>
</div>
<div id="notificationPopup"></div>
<footer class="footer">
    <div class="container footer-content">
        <div class="footer-info">
            <h3>greenhauL</h3>
            <p>Mudanzas sostenibles, sin complicaciones.</p>
            <p><i class="fas fa-phone-alt"></i> +52 55 1234 5678</p>
            <p><i class="fas fa-envelope"></i> info@greenhauL.com</p>
            <p><i class="fas fa-map-marker-alt"></i> Ciudad de M√©xico</p>
        </div>
        <div class="footer-links">
            <h3>Enlaces R√°pidos</h3>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="productos.html">Productos</a></li>
                <li><a href="servicios.html">Servicios</a></li>
                <li><a href="nosotros.html">Nosotros</a></li>
                <li><a href="contacto.html">Contacto</a></li>
                <li><a href="cuenta.html">Mi Cuenta</a></li>
            </ul>
        </div>
        <div class="footer-social-links">
            <h3>S√≠guenos</h3>
            <div class="social-icons-wrapper">
                <a href="#" class="social-icon" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-icon" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="social-icon" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        &copy; <span id="current-year">2025</span> greenhauL. Todos los derechos reservados.
    </div>
</footer>
<div class="cart-modal-overlay" id="cartModalOverlay">
    <div class="cart-modal">
        <div class="cart-modal-header">
            <h2>Tu Carrito</h2>
            <button class="close-modal-btn" id="closeCartModalBtn" title="Cerrar">&times;</button>
        </div>
        <div class="cart-modal-body" id="cartItemsContainer"></div>
        <div class="cart-modal-footer">
            <div class="cart-summary">
                <p>Subtotal: <span id="cartSubtotal">$0.00</span></p>
                <p>Impuestos (16%): <span id="cartTaxes">$0.00</span></p>
                <h3>Total: <span id="cartTotal">$0.00</span></h3>
            </div>
            <div class="cart-footer-buttons">
                <button class="btn btn-secondary empty-cart-btn" id="emptyCartBtn">Vaciar Carrito</button>
                <a href="confirmacion-entrega-recoleccion.html" class="btn btn-primary proceed-to-checkout-btn" id="proceedToCheckoutBtn">Finalizar Compra</a>
            </div>
        </div>
    </div>
</div>
<div class="cart-notification" id="cartNotification">
    <div class="notification-content">
        <div class="notification-icon-wrapper"><span class="notification-icon"></span></div>
        <p id="notificationText"></p>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="assets/js/main.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- Backend URL y elementos principales ---
    const backendUrl = 'https://greenhaul-backend-production.up.railway.app';
    const loggedInUser = JSON.parse(localStorage.getItem('greenhaulUser'));

    // Redireccionar si no hay usuario logueado
    if (!loggedInUser || !loggedInUser.id) {
        window.location.href = 'login.html';
        return;
    }

    let userData = {}; // Objeto para almacenar los datos del usuario actual
    let map, marker; // Mantenemos map y marker para la funcionalidad visual del mapa

    // --- Animaci√≥n inicial de widgets y elementos ---
    document.querySelectorAll('.widget-card').forEach((el, i) => {
        el.style.animationDelay = (i * 0.15) + 's';
    });
    document.querySelectorAll('.action-card').forEach((el, i) => {
        el.style.animationDelay = (i * 0.1) + 's';
    });

    // --- Elementos del DOM ---
    const userCardName = document.getElementById('userCardName');
    const userCardEmail = document.getElementById('userCardEmail');
    const userNameSpan = document.getElementById('userName');
    const accountTitle = document.getElementById('account-title');
    const dashboardUserName = document.getElementById('dashboardUserName'); 
    const widgetPedidos = document.getElementById('widgetPedidos');
    const widgetCompletados = document.getElementById('widgetCompletados');
    const widgetDirecciones = document.getElementById('widgetDirecciones');
    const widgetAhorro = document.getElementById('widgetAhorro');
    const widgetAhorroEquivalente = document.getElementById('widgetAhorroEquivalente');
    const navLinks = document.querySelectorAll('.account-nav-link');
    const sections = document.querySelectorAll('.account-section');
    const orderHistoryContainer = document.getElementById('order-history-container');
    const recentOrdersSummaryContainer = document.getElementById('recent-orders-summary-container');
    const profileForm = document.getElementById('profileForm');
    const profileNameInput = document.getElementById('profile-name');
    const profileLastNameInput = document.getElementById('profile-lastname');
    const profileEmailInput = document.getElementById('profile-email');
    const profileWhatsappInput = document.getElementById('profile-whatsapp');
    const addAddressBtn = document.getElementById('addAddressBtn');
    const addressModal = document.getElementById('addressModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const addressForm = document.getElementById('addressForm');
    const addressListContainer = document.getElementById('address-list-container');
    const modalTitle = document.getElementById('modalTitle');
    const addressIdInput = document.getElementById('addressId');
    const addressNameInput = document.getElementById('address-name'); 
    const streetInput = document.getElementById('address-street');
    const neighborhoodInput = document.getElementById('address-neighborhood'); 
    const cityInput = document.getElementById('address-city');
    const stateInput = document.getElementById('address-state');
    const postalCodeInput = document.getElementById('address-postal-code');
    const referencesInput = document.getElementById('address-references'); 
    const notificationPopup = document.getElementById('notificationPopup');
    const logoutBtn = document.getElementById('logoutBtn');

    // --- Funciones de Utilidad ---

    /**
     * Muestra una notificaci√≥n emergente.
     * @param {string} message - El mensaje a mostrar.
     * @param {boolean} isError - Si es true, la notificaci√≥n ser√° de error.
     */
    function showNotification(message, isError = false) {
        if (!notificationPopup) return;
        notificationPopup.textContent = message; 
        notificationPopup.className = 'show' + (isError ? ' error' : '');
        setTimeout(() => notificationPopup.className = '', 3000);
    }

    /**
     * Actualiza la informaci√≥n del usuario en la barra lateral.
     * @param {object} user - Objeto con los datos del usuario.
     */
    function updateSidebar(user) {
        userCardName.textContent = user.name ?? 'Usuario';
        userCardEmail.textContent = user.email ?? '';
        userNameSpan.textContent = user.name ? user.name.split(' ')[0] : 'Usuario';
        accountTitle.textContent = `Panel de Control de ${user.name || 'Usuario'}`;
        dashboardUserName.textContent = user.name ? user.name.split(' ')[0] : 'Usuario';
    }

    // --- Funciones para el Dashboard (Resumen) ---

    /**
     * Actualiza los widgets del dashboard con datos del backend.
     */
    async function updateDashboardWidgetsFromBackend() {
        try {
            const res = await fetch(`${backendUrl}/api/users/${loggedInUser.id}/dashboard`);
            if (!res.ok) throw new Error('Error al cargar estad√≠sticas del dashboard.');
            const stats = await res.json();
            widgetPedidos.textContent = stats.pedidos_activos ?? 0;
            widgetCompletados.textContent = stats.pedidos_completados ?? 0;
            widgetDirecciones.textContent = stats.direcciones ?? 0;
            widgetAhorro.textContent = stats.ahorro_kg_co2 + ' kg';
            widgetAhorroEquivalente.textContent =
                `Equivale a ${stats.arboles_equivalentes} √°rboles üå≥ o ${stats.km_equivalentes} km en auto üöó`;
            displayRecentOrders(stats.recent_orders || []);
        } catch (e) {
            showNotification('No se pudieron cargar las estad√≠sticas del dashboard. Carga parcial de la informaci√≥n.', true);
            widgetAhorro.textContent = '0 kg';
            widgetAhorroEquivalente.textContent = '';
            recentOrdersSummaryContainer.innerHTML = '<p>No se pudieron cargar los pedidos recientes.</p>';
        }
    }

    /**
     * Muestra un resumen de los √∫ltimos pedidos en el dashboard.
     * @param {Array<object>} orders - Lista de objetos de pedido.
     */
    function displayRecentOrders(orders) {
        recentOrdersSummaryContainer.innerHTML = '';
        if (!orders || orders.length === 0) {
            recentOrdersSummaryContainer.innerHTML = '<p>No hay pedidos recientes para mostrar.</p>';
            return;
        }
        orders.slice(0, 3).forEach(order => { // Mostrar solo los 3 m√°s recientes
            const estado = order.status === 'completado' ? 'Completado' : 'Activo';
            orderHistoryContainer.innerHTML += `
                <div class="order-item slide-up">
                    <div><strong>ID:</strong> ${order.id}</div>
                    <div><strong>Fecha:</strong> ${order.date}</div>
                    <div><strong>Total:</strong> $${parseFloat(order.total).toFixed(2)} MXN</div>
                    <div><strong>Estado:</strong> <span class="order-item-status status-${estado.toLowerCase()}">${estado}</span></div>
                </div>`;
        });
    }

    // --- Manejo de Pesta√±as (Secciones) ---

    /**
     * Activa la secci√≥n correspondiente y actualiza la navegaci√≥n.
     * @param {string} sectionId - El ID de la secci√≥n a activar (ej. 'dashboard', 'pedidos').
     */
    function activateSection(sectionId) {
        navLinks.forEach(l => l.classList.remove('active'));
        sections.forEach(s => s.classList.remove('active', 'fade-in'));
        
        // Encuentra el enlace y la secci√≥n objetivo
        const targetLink = document.querySelector(`.account-nav-link[data-section="${sectionId}"]`);
        const targetSection = document.getElementById(`${sectionId}-section`);

        if (targetLink) targetLink.classList.add('active');
        if (targetSection) targetSection.classList.add('active', 'fade-in');

        // Cargar datos espec√≠ficos para cada secci√≥n
        switch (sectionId) {
            case 'dashboard':
                updateDashboardWidgetsFromBackend(); 
                break;
            case 'pedidos':
                loadOrders(); 
                break;
            case 'perfil':
                populateProfileForm();
                break;
            case 'direcciones':
                loadAddresses(); 
                break;
            case 'seguridad':
                break;
            case 'notificaciones':
                break;
        }
    }

    // Event listeners para los enlaces de navegaci√≥n de la barra lateral
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.dataset.section;
            activateSection(sectionId);
        });
    });

    // Event listeners para los botones de "Acciones R√°pidas" en el dashboard
    document.querySelectorAll('.quick-actions .btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const targetSection = e.target.dataset.targetSection;
            if (targetSection) {
                activateSection(targetSection);
            } else if (e.target.href) { 
                window.location.href = e.target.href;
            }
        });
    });
    document.querySelector('.recent-orders-summary + div .btn').addEventListener('click', () => {
        activateSection('pedidos');
    });


    // --- Funciones para Pedidos ---

    /**
     * Carga y muestra el historial de pedidos del usuario.
     */
    async function loadOrders() {
        orderHistoryContainer.innerHTML = '<div class="order-item"><span>Cargando pedidos...</span></div>';
        try {
            const response = await fetch(`${backendUrl}/api/users/${loggedInUser.id}/orders`);
            if (!response.ok) throw new Error('Error al cargar pedidos.');
            const orders = await response.json();
            orderHistoryContainer.innerHTML = '';
            if (!orders || orders.length === 0) {
                orderHistoryContainer.innerHTML = '<p>No tienes pedidos a√∫n. ¬°An√≠mate a programar tu primera mudanza sostenible!</p>';
                return;
            }
            orders.sort((a, b) => new Date(b.date) - new Date(a.date)); // Ordenar por fecha descendente
            orders.forEach(order => {
                const estado = order.status === 'completado' ? 'Completado' : 'Activo';
                orderHistoryContainer.innerHTML += `
                    <div class="order-item slide-up">
                        <div><strong>ID:</strong> ${order.id}</div>
                        <div><strong>Fecha:</strong> ${order.date}</div>
                        <div><strong>Total:</strong> $${order.total} MXN</div>
                        <div><strong>Estado:</strong> <span class="order-item-status status-${estado.toLowerCase()}">${estado}</span></div>
                    </div>`;
            });
        } catch (error) {
            showNotification(`Error al cargar pedidos: ${error.message}`, true);
            orderHistoryContainer.innerHTML = '<p>Error al cargar pedidos. Por favor, int√©ntalo de nuevo m√°s tarde.</p>';
        }
    }

    // --- Funciones para Perfil ---

    /**
     * Rellena el formulario de perfil con los datos del usuario.
     */
    function populateProfileForm() {
        if (!userData) return;
        profileNameInput.value = userData.name || '';
        profileLastNameInput.value = userData.surname || '';
        profileEmailInput.value = userData.email || '';
        profileWhatsappInput.value = userData.whatsapp || '';
    }

    // Event listener para el formulario de perfil
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';

        const updatedData = {
            email: profileEmailInput.value,
            whatsapp: profileWhatsappInput.value,
        };

        try {
            const response = await fetch(`${backendUrl}/api/users/${loggedInUser.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Error al actualizar el perfil.');

            userData = { ...loggedInUser, ...result.user }; 
            localStorage.setItem('greenhaulUser', JSON.stringify(userData)); 
            showNotification('Perfil actualizado con √©xito.');
            updateSidebar(userData); 
        } catch (error) {
            showNotification(error.message, true);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });

    // --- Funciones para Direcciones (Mapa Restaurado, sin guardar Lat/Lng) ---

    /**
     * Inicializa o re-inicializa el mapa de Leaflet.
     * @param {number} lat - Latitud inicial.
     * @param {number} lng - Longitud inicial.
     */
    function initMap(lat = 19.4326, lng = -99.1332) { // Coordenadas de CDMX por defecto
        if (map) {
            map.remove(); // Eliminar la instancia anterior del mapa si existe
            map = null;
        }
        map = L.map('address-map').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        marker = L.marker([lat, lng], { draggable: true }).addTo(map);

        marker.on('dragend', function(event) {
            const pos = marker.getLatLng();
            reverseGeocode(pos.lat, pos.lng);
        });

        // Asegurarse de que el mapa se renderice correctamente en el modal
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 200);
    }

    /**
     * Realiza geocodificaci√≥n inversa para obtener la direcci√≥n a partir de coordenadas.
     * Esta funci√≥n solo se usa para rellenar el formulario de forma visual, no para enviar al backend.
     * @param {number} lat - Latitud.
     * @param {number} lng - Longitud.
     */
    async function reverseGeocode(lat, lng) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.address) {
                const addr = data.address;
                let street = addr.road || '';
                let houseNumber = addr.house_number || '';
                let neighborhood = addr.suburb || addr.neighbourhood || '';

                // Intentar obtener el n√∫mero de casa de 'house_number' o de 'display_name'
                let fullStreet = street.trim();
                if (houseNumber) {
                    fullStreet += ` ${houseNumber}`;
                } else if (data.display_name) {
                    const streetRegex = new RegExp(`^${escapeRegExp(street)}\\s*(\\d+[A-Za-z]?)?\\b`, 'i');
                    const match = data.display_name.match(streetRegex);
                    if (match && match[1]) {
                        fullStreet = `${street} ${match[1]}`;
                    } else {
                        const genericNumberMatch = data.display_name.match(/\b(\d+[A-Za-z]?)\b/);
                        if (genericNumberMatch && street && !street.includes(genericNumberMatch[1])) {
                             fullStreet = `${street} ${genericNumberMatch[1]}`;
                        }
                    }
                }
                
                streetInput.value = fullStreet.trim();
                neighborhoodInput.value = neighborhood;
                cityInput.value = addr.city || addr.town || addr.village || '';
                stateInput.value = addr.state || '';
                postalCodeInput.value = addr.postcode || '';
            } else {
                streetInput.value = '';
                neighborhoodInput.value = '';
                cityInput.value = '';
                stateInput.value = '';
                postalCodeInput.value = '';
                showNotification('No se pudo obtener la direcci√≥n desde el mapa.', true);
            }
        } catch (error) {
            showNotification('Error de conexi√≥n al servicio de geocodificaci√≥n inversa.', true);
        }
    }

    // Helper para escapar caracteres especiales en una RegExp
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the matched substring
    }

    /**
     * Realiza geocodificaci√≥n para ubicar una direcci√≥n en el mapa.
     * Esta funci√≥n solo se usa para rellenar el formulario de forma visual, no para enviar al backend.
     */
    async function geocodeAddress() {
        const address = `${streetInput.value}, ${neighborhoodInput.value}, ${cityInput.value}, ${stateInput.value}, ${postalCodeInput.value}`;
        if (address.trim().length < 10) return; // M√≠nimo de caracteres para una b√∫squeda efectiva

        try {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            const response = await fetch(url);
            const results = await response.json();

            if (results && results.length > 0) {
                const { lat, lon } = results[0];
                const newPosition = L.latLng(lat, lon);
                marker.setLatLng(newPosition);
                map.setView(newPosition, 16);
            } else {
                showNotification('No se pudo ubicar la direcci√≥n en el mapa con los datos proporcionados.', true);
            }
        } catch (error) {
            showNotification('Error de conexi√≥n al servicio de geocodificaci√≥n.', true);
        }
    }

    // Event listeners para autocompletar el mapa al escribir la direcci√≥n
    [streetInput, neighborhoodInput, cityInput, stateInput, postalCodeInput].forEach(input => {
        input.addEventListener('blur', () => { geocodeAddress(); });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                geocodeAddress();
            }
        });
    });

    /**
     * Abre el modal de direcci√≥n y, opcionalmente, inicializa el mapa.
     * @param {number} lat - Latitud inicial para el mapa (opcional).
     * @param {number} lng - Longitud inicial para el mapa (opcional).
     */
    function openModal(lat = 19.4326, lng = -99.1332) {
        addressModal.classList.add('show');
        // ¬°IMPORTANTE! Se llama a initMap para mostrar el mapa.
        setTimeout(() => { initMap(lat, lng); }, 50); 
    }

    /**
     * Cierra el modal de direcci√≥n y limpia el formulario.
     */
    function closeModal() {
        addressModal.classList.remove('show');
        addressForm.reset();
        addressIdInput.value = '';
        // ¬°IMPORTANTE! Eliminar el mapa de Leaflet al cerrar el modal para liberar recursos.
        if (map) {
            map.remove();
            map = null;
        }
    }

    // Event listeners para el modal de direcci√≥n
    if (addAddressBtn) addAddressBtn.addEventListener('click', () => {
        modalTitle.textContent = 'Agregar Nueva Direcci√≥n';
        // Al agregar, el mapa se centra en CDMX por defecto
        openModal(); 
    });
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
    if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeModal);

    // Env√≠o del formulario de direcci√≥n (Agregar/Editar)
    if (addressForm) addressForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const addressId = addressIdInput.value;
        const isUpdating = !!addressId;
        const submitBtn = addressForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';

        // ¬°IMPORTANTE! Solo incluimos los campos que queremos guardar en la DB.
        // Latitud y longitud NO se env√≠an al backend, aunque el mapa est√© visible.
        const addressData = {
            name: addressNameInput.value,
            street: streetInput.value,
            neighborhood: neighborhoodInput.value,
            city: cityInput.value,
            state: stateInput.value,
            postal_code: postalCodeInput.value,
            references: referencesInput.value,
            // latitude y longitude NO se incluyen aqu√≠ para el backend.
        };

        const url = isUpdating ? `${backendUrl}/api/addresses/${addressId}` : `${backendUrl}/api/users/${loggedInUser.id}/addresses`;
        const method = isUpdating ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(addressData)
            });
            const result = await response.json();

            if (!response.ok) throw new Error(result.message || 'Error al guardar la direcci√≥n.');

            showNotification(result.message || 'Direcci√≥n guardada correctamente.');
            closeModal();
            await loadAddresses(); // Recargar la lista de direcciones
        } catch (error) {
            showNotification(error.message, true);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });

    /**
     * Carga y muestra la lista de direcciones del usuario.
     */
    async function loadAddresses() {
        try {
            const response = await fetch(`${backendUrl}/api/users/${loggedInUser.id}/addresses`);
            if (!response.ok) throw new Error('No se pudieron cargar las direcciones.');
            const addresses = await response.json();
            addressListContainer.innerHTML = ''; 

            if (addresses.length === 0) {
                addressListContainer.innerHTML = '<p>A√∫n no tienes direcciones guardadas. ¬°Agrega una para agilizar tus futuros servicios!</p>';
                return;
            }

            addresses.forEach(addr => {
                const card = document.createElement('div');
                card.className = 'address-card slide-up';
                card.innerHTML = `
                    <div class="address-card-header">
                        <h4><i class="fas fa-map-marker-alt"></i> ${addr.name || 'Direcci√≥n sin nombre'}</h4>
                    </div>
                    <div class="address-card-body">
                        <p>${addr.street}, ${addr.neighborhood || ''}</p>
                        <p>${addr.city}, ${addr.state || ''} ${addr.postal_code || ''}</p>
                        ${addr.references ? `<p class="address-references-text">Ref: ${addr.references}</p>` : ''}
                    </div>
                    <div class="address-card-actions">
                        <button class="btn btn-outline edit-btn" data-id="${addr.id}">Editar</button>
                        <button class="btn-tertiary delete-btn" data-id="${addr.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </div>`;
                addressListContainer.appendChild(card);
            });
        } catch (error) {
            showNotification(error.message, true);
            addressListContainer.innerHTML = '<p>Error al cargar direcciones. Por favor, int√©ntalo de nuevo.</p>';
        }
    }

    // Event listener para acciones en las tarjetas de direcci√≥n (Editar/Eliminar)
    if (addressListContainer) addressListContainer.addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');

        if (editBtn) {
            const id = editBtn.dataset.id;
            try {
                const response = await fetch(`${backendUrl}/api/addresses/${id}`);
                if (!response.ok) throw new Error('No se pudo cargar la direcci√≥n para editar.');
                const addressToEdit = await response.json();

                modalTitle.textContent = 'Editar Direcci√≥n';
                addressIdInput.value = addressToEdit.id;
                addressNameInput.value = addressToEdit.name || ''; 
                streetInput.value = addressToEdit.street || '';
                neighborhoodInput.value = addressToEdit.neighborhood || ''; 
                cityInput.value = addressToEdit.city || '';
                stateInput.value = addressToEdit.state || '';
                postalCodeInput.value = addressToEdit.postal_code || '';
                referencesInput.value = addressToEdit.references || ''; 

                // Al editar, si tenemos lat/lng del backend, inicializamos el mapa con ellos.
                // Si el backend no los guarda, simplemente se usar√° la ubicaci√≥n por defecto (CDMX).
                openModal(addressToEdit.latitude, addressToEdit.longitude); 

            } catch (error) {
                showNotification(error.message, true);
            }
        }

        if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta direcci√≥n? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const response = await fetch(`${backendUrl}/api/addresses/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Error al eliminar la direcci√≥n.');
                    showNotification(result.message || 'Direcci√≥n eliminada con √©xito.');
                    await loadAddresses(); 
                } catch (error) {
                    showNotification(error.message, true);
                }
            }
        }
    });

    // --- Funciones para Seguridad (Nueva Secci√≥n) ---
    const securityForm = document.getElementById('securityForm');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmNewPasswordInput = document.getElementById('confirm-new-password');

    if (securityForm) {
        securityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = securityForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Actualizando...';

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (newPassword !== confirmNewPassword) {
                showNotification('Las nuevas contrase√±as no coinciden.', true);
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            if (newPassword.length < 6) {
                showNotification('La nueva contrase√±a debe tener al menos 6 caracteres.', true);
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }

            // Simulaci√≥n de una llamada al backend para cambiar contrase√±a
            try {
                const response = await new Promise(resolve => setTimeout(() => {
                    // Placeholder: En una app real, esto ser√≠a una llamada PUT/POST al backend
                    if (currentPassword === "password_actual_valida") { 
                        resolve({ ok: true, json: () => Promise.resolve({ message: 'Contrase√±a actualizada con √©xito.' }) });
                    } else {
                        resolve({ ok: false, json: () => Promise.resolve({ message: 'Contrase√±a actual incorrecta.' }) });
                    }
                }, 1000));

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Error al cambiar la contrase√±a.');

                showNotification(result.message);
                securityForm.reset(); 
            } catch (error) {
                showNotification(error.message, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });
    }

    // --- Funciones para Notificaciones (Nueva Secci√≥n) ---
    const notificationsForm = document.getElementById('notificationsForm');
    const toggle2FABtn = document.getElementById('toggle2FABtn');

    if (notificationsForm) {
        notificationsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showNotification('La funcionalidad de guardar preferencias de notificaci√≥n a√∫n no est√° implementada.', false);
        });
    }

    if (toggle2FABtn) {
        toggle2FABtn.addEventListener('click', () => {
            showNotification('La autenticaci√≥n de dos factores a√∫n no est√° implementada.', false);
        });
    }

    // --- Cerrar sesi√≥n ---
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('greenhaulUser');
            window.location.href = 'index.html';
        });
    }

    // --- Inicializaci√≥n de datos de usuario y carga inicial ---

    /**
     * Carga los datos completos del usuario desde el backend al iniciar la p√°gina.
     * @param {string} userId - ID del usuario logueado.
     */
    async function fetchUserData(userId) {
        try {
            const response = await fetch(`${backendUrl}/api/users/${userId}`);
            if (!response.ok) throw new Error('Usuario no encontrado en el servidor.');
            const result = await response.json();
            userData = result.user; 
            localStorage.setItem('greenhaulUser', JSON.stringify(userData)); 
            updateSidebar(userData); 
            activateSection('dashboard'); 
        } catch (error) {
            showNotification(`Error al cargar el perfil: ${error.message}. Por favor, intenta de nuevo.`, true);
        }
    }

    // Llamada inicial para cargar los datos del usuario y activar la primera secci√≥n
    fetchUserData(loggedInUser.id);
});
</script>
</body>
</html>
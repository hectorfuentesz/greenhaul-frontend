<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - GreenHaul</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css"> 
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <!-- Mercado Pago SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* ... (puedes mantener aquí todo tu CSS tal como lo tienes) ... */
    </style>
</head>
<body>
    <header class="navbar">
        <!-- ... (tu encabezado tal como lo tienes) ... -->
    </header>
    <main class="page-content">
        <div class="container">
            <div class="section-title">
                <h2>Finalizar Compra</h2>
                <p>Estás a un solo paso de completar tu pedido.</p>
            </div>
            <div class="payment-layout">
                <div class="form-container">
                    <h3><i class="fas fa-credit-card"></i> Detalles de Pago</h3>
                    <form id="paymentForm">
                        <div class="name-grid">
                            <div class="form-group">
                                <label for="firstName">Nombre(s)</label>
                                <input type="text" id="firstName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName1">Apellido Paterno</label>
                                <input type="text" id="lastName1" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName2">Apellido Materno</label>
                                <input type="text" id="lastName2" class="form-control" required>
                            </div>
                        </div>
                        <!-- Mercado Pago Card Form -->
                        <div id="form-checkout" style="margin-bottom:20px;">
                            <div id="form-checkout__cardNumber" class="form-group"></div>
                            <div style="display: flex; gap: 20px;">
                                <div id="form-checkout__expirationDate" class="form-group" style="flex: 1;"></div>
                                <div id="form-checkout__securityCode" class="form-group" style="flex: 1;"></div>
                            </div>
                            <div class="form-group">
                                <label for="form-checkout__cardholderEmail">Correo electrónico</label>
                                <input type="email" id="form-checkout__cardholderEmail" class="form-control" required>
                            </div>
                            <div id="form-checkout__installments" class="form-group"></div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-submit" id="payBtn">Pagar Ahora</button>
                    </form>
                </div>
                <div class="summary-container">
                    <h3><i class="fas fa-shopping-cart"></i> Resumen de tu Pedido</h3>
                    <ul class="order-summary-list" id="summaryItemsContainer"></ul>
                    <ul class="summary-totals">
                        <li><span>Subtotal:</span> <span id="summarySubtotal">$0.00</span></li>
                        <li><span>Impuestos (16%):</span> <span id="summaryTaxes">$0.00</span></li>
                        <li class="total"><span>Total:</span> <span id="summaryTotal">$0.00</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    <div class="popup-overlay" id="orderSuccessPopup">
        <div class="popup-card">
            <div class="popup-icon"><i class="fas fa-check"></i></div>
            <h2>¡Pedido Realizado!</h2>
            <p class="message">Tu compra ha sido confirmada. Un asesor se comunicará por WhatsApp para dar seguimiento.</p>
            <div class="order-details-box">
                <p>Tu número de orden es:</p>
                <div class="order-id-wrapper">
                    <strong id="orderId"></strong>
                    <button id="copyOrderIdBtn" class="copy-btn" title="Copiar al portapapeles">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            </div>
            <p class="message" style="font-size: 0.9rem; margin-top: -15px; margin-bottom: 30px;">(Recibirás los detalles completos en tu correo)</p>
            <div class="popup-actions">
                <a href="cuenta.html" class="btn btn-secondary">Ir a Mis Pedidos</a>
                <a href="index.html" class="btn btn-primary">Volver al Inicio</a>
            </div>
        </div>
    </div>
    <script src="assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const backendUrl = 'https://greenhaul-backend-production.up.railway.app';
            const mpPublicKey = 'TEST-9fc6389c-411c-4e70-b4e0-5f0d058c795b';

            // --- Tu lógica de renderizado de carrito (sin cambios) ---
            // ... (puedes mantener aquí tu código de renderizado de carrito, autenticación, etc) ...

            // Variables globales para resumen de compra
            let finalTotalAmount = 0;
            // ... (tu función renderOrderSummary puede quedarse igual, solo asegúrate de actualizar finalTotalAmount) ...

            // Mercado Pago Checkout API
            const mp = new MercadoPago(mpPublicKey, { locale: 'es-MX' });

            // Obtén el monto final (finalTotalAmount) después de renderizar el resumen
            // Si tu monto depende del carrito, asegúrate de que esté actualizado antes de inicializar el form

            // Inicializa el formulario de Mercado Pago
            const cardForm = mp.cardForm({
                amount: finalTotalAmount.toFixed(2),
                autoMount: true,
                form: {
                    id: "paymentForm",
                    cardholderName: {
                        id: "firstName",
                        placeholder: "Nombre(s)"
                    },
                    cardholderLastName: {
                        id: "lastName1",
                        placeholder: "Apellido"
                    },
                    cardholderEmail: {
                        id: "form-checkout__cardholderEmail",
                        placeholder: "Correo electrónico"
                    },
                },
                fields: {
                    cardNumber: {
                        id: "form-checkout__cardNumber",
                        placeholder: "Número de Tarjeta"
                    },
                    expirationDate: {
                        id: "form-checkout__expirationDate",
                        placeholder: "MM/AA"
                    },
                    securityCode: {
                        id: "form-checkout__securityCode",
                        placeholder: "CVV"
                    },
                    installments: {
                        id: "form-checkout__installments",
                        placeholder: "Cuotas"
                    }
                },
                callbacks: {
                    onFormMounted: error => {
                        if (error) return console.warn("Form mounted handling error: ", error);
                    },
                    onSubmit: async event => {
                        event.preventDefault();
                        const payBtn = document.getElementById('payBtn');
                        payBtn.disabled = true;
                        payBtn.textContent = "Procesando...";

                        // Recupera los datos seguros del formulario de Mercado Pago
                        const {
                            paymentMethodId,
                            issuerId,
                            cardholderEmail,
                            amount,
                            token,
                            installments,
                            identificationNumber,
                            identificationType
                        } = cardForm.getCardFormData();

                        // Leer los IDs de direcciones confirmadas desde localStorage
                        const deliveryAddressId = parseInt(localStorage.getItem('deliveryAddressId'), 10);
                        const pickupAddressId = parseInt(localStorage.getItem('pickupAddressId'), 10);
                        const loggedInUser = JSON.parse(localStorage.getItem('greenhaulUser'));
                        const shoppingCart = JSON.parse(localStorage.getItem('shoppingCart')) || { items: [], rentalDates: null, totalDays: 0 };

                        if (!deliveryAddressId || !pickupAddressId) {
                            alert('Debes confirmar ambas direcciones antes de finalizar el pedido.');
                            payBtn.disabled = false;
                            payBtn.textContent = "Pagar Ahora";
                            return;
                        }

                        // Prepara el cuerpo de la orden y pago
                        const orderData = {
                            user_id: loggedInUser ? loggedInUser.id : null,
                            cartItems: shoppingCart.items.map(item => ({
                                id: item.id,
                                name: item.name,
                                price: item.price,
                                quantity: item.quantity,
                                rentalDays: item.rentalDays
                            })),
                            total_amount: finalTotalAmount,
                            rentalDates: shoppingCart.rentalDates,
                            delivery_address_id: deliveryAddressId,
                            pickup_address_id: pickupAddressId,
                            payment: {
                                token,
                                paymentMethodId,
                                issuerId,
                                email: cardholderEmail,
                                amount,
                                installments,
                                identificationNumber,
                                identificationType
                            }
                        };

                        try {
                            const response = await fetch(`${backendUrl}/api/mp/process-payment`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(orderData)
                            });
                            const result = await response.json();
                            if (!response.ok) {
                                throw new Error(result.message || 'No se pudo procesar el pago');
                            }
                            // Muestra popup éxito y limpia carrito
                            const orderSuccessPopup = document.getElementById('orderSuccessPopup');
                            const orderIdElement = document.getElementById('orderId');
                            const copyBtn = document.getElementById('copyOrderIdBtn');
                            const realOrderId = result.order ? result.order.id : (result.orderId || 'N/A'); 
                            orderIdElement.textContent = `GRNHL-${realOrderId}`;
                            orderSuccessPopup.classList.add('active');
                            if (typeof confetti === 'function') { confetti({ particleCount: 150, spread: 180, origin: { y: 0.6 } }); }
                            localStorage.removeItem('shoppingCart');
                            localStorage.removeItem('deliveryAddressId');
                            localStorage.removeItem('pickupAddressId');
                            copyBtn.onclick = function() {
                                navigator.clipboard.writeText(`GRNHL-${realOrderId}`).then(() => {
                                    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                                    setTimeout(() => { copyBtn.innerHTML = '<i class="far fa-copy"></i>'; }, 2000);
                                });
                            };
                        } catch (error) {
                            alert(`Error al procesar el pago: ${error.message}`);
                            payBtn.disabled = false;
                            payBtn.textContent = "Pagar Ahora";
                        }
                    }
                }
            });

            // ... (puedes mantener aquí el resto de tu lógica para inputs, renderOrderSummary, navbar, etc) ...
        });
    </script>
</body>
</html>